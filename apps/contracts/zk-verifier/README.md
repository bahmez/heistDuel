# zk-verifier — Groth16 Verifier Contract

Soroban contract that verifies **Groth16** proofs over **BN254**. It is the contract actually deployed and used by the heist game: the heist contract calls it from `submit_turn` to verify each turn’s ZK proof.

- **No dependency on zk-verifier-core** — Verification is implemented here using Soroban Protocol 25 **BN254 host functions** only (`pairing_check`, `g1_add`, `g1_mul`, `g2_add`), so the WASM stays small (~15 KB).
- **VK format** — Binary (not JSON). The VK is uploaded once by the admin via `set_vk`.

## VK binary format (set_vk)

| Offset | Size | Content |
|--------|------|---------|
| 0   | 64  | `alpha_g1` (G1: x \|\| y, 32 bytes each, big-endian) |
| 64  | 128 | `beta_g2` (G2: x0 \|\| x1 \|\| y0 \|\| y1) |
| 192 | 128 | `gamma_g2` |
| 320 | 128 | `delta_g2` |
| 448 | 4   | `n_ic` (u32 BE) = number of public inputs + 1 |
| 452 | n_ic × 64 | IC points (G1 each) |

Generated by the Circom/snarkjs pipeline (e.g. `apps/circuits/turn_validity_g16/build/vk.bin`).

## Proof blob format (verify_proof_with_stored_vk)

| Offset | Size | Content |
|--------|------|---------|
| 0  | 4   | `n_pub` (u32 BE) = 1 for our circuit |
| 4  | 32  | Public input: `pi_hash` (BN254 Fr, big-endian) |
| 36 | 64  | `pi_a` (G1) |
| 100| 128 | `pi_b` (G2) |
| 228| 64  | `pi_c` (G1) |

**Total: 292 bytes** for a single public input.

The heist contract reads `pi_hash` from bytes `[4..36]` and compares it to the expected value computed from `TurnZkPublic` via Poseidon.

## Public API

| Method | Description |
|--------|-------------|
| `__constructor(admin)` / `initialize(admin)` | Set admin (one-time). |
| `set_vk(env, vk: Bytes)` | Store VK (admin-only). Returns SHA-256 hash of VK. |
| `get_vk_hash()` | Return stored VK hash, or `None` if not set. |
| `verify_proof_with_stored_vk(proof_blob: Bytes)` | Verify Groth16 proof; on success, store `proof_id = keccak256(proof_blob)` and return it. |
| `is_verified(proof_id)` | Returns whether this proof_id was successfully verified. |
| `upgrade(new_wasm_hash)` | Admin-only WASM upgrade. |

## Verification equation

Standard Groth16 pairing check:

`e(-A, B) · e(α, β) · e(vk_x, γ) · e(C, δ) == 1`

with `vk_x = IC[0] + Σᵢ (public_input[i] · IC[i+1])`. For our circuit there is one public input (`pi_hash`).

## Build and test

```bash
cd apps/contracts/zk-verifier
cargo build --target wasm32v1-none --release
cargo test
```

Deployment and VK upload are done by `apps/contracts/scripts/deploy.ts`.
